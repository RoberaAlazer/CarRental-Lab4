name: Build and deploy WebAPI and MVC

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-webapi:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      - run: dotnet restore Maintenance.WebAPI/Maintenance.WebAPI.csproj
      - run: dotnet build Maintenance.WebAPI/Maintenance.WebAPI.csproj -c Release --no-restore
      - run: dotnet publish Maintenance.WebAPI/Maintenance.WebAPI.csproj -c Release -o ${{ runner.temp }}/webapi --no-build
      - uses: actions/upload-artifact@v4
        with:
          name: webapi
          path: ${{ runner.temp }}/webapi

  deploy-webapi:
    runs-on: ubuntu-latest
    needs: build-webapi
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: webapi
          path: webapi
      - uses: azure/webapps-deploy@v3
        with:
          app-name: 'maintenance-webapi-8768364'
          slot-name: 'Production'
          package: webapi
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_0E03B8CC22DB4428993C5E2027AD8446 }}

  build-mvc:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      - run: dotnet restore _8768364RobbieAlazer_MVC/_8768364RobbieAlazer_MVC.csproj
      - run: dotnet build _8768364RobbieAlazer_MVC/_8768364RobbieAlazer_MVC.csproj -c Release --no-restore
      - run: dotnet publish _8768364RobbieAlazer_MVC/_8768364RobbieAlazer_MVC.csproj -c Release -o ${{ runner.temp }}/mvc --no-build
      - uses: actions/upload-artifact@v4
        with:
          name: mvc
          path: ${{ runner.temp }}/mvc

  deploy-mvc:
    runs-on: ubuntu-latest
    needs: build-mvc
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: mvc
          path: mvc
      - uses: azure/webapps-deploy@v3
        with:
          app-name: 'carrental-mvc-8768364'
          slot-name: 'Production'
          package: mvc
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_MVC }}
